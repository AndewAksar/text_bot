# Telegram Text Bot

Telegram-бот, который реагирует на триггерные слова или фразы в сообщениях в заданной группе, отправляя заранее заданные ответы с учётом задержки и ограничения частоты.

## Описание

Бот предназначен для автоматической обработки текстовых сообщений в Telegram-группе. Он реагирует на ключевые слова или фразы, определённые в конфигурации, и отправляет ответы с заданной задержкой. Поддерживает ограничение частоты ответов и логирование для отладки.

### Основные возможности
- Реакция на триггерные слова или фразы с использованием регулярных выражений.
- Настраиваемые ответы и задержки для каждого триггера.
- Ограничение частоты ответов (не чаще одного ответа каждые 10 секунд).
- Логирование действий и обработка ошибок Telegram API.
- Хранение конфиденциальных данных в переменных окружения (`.env`).

## Структура проекта
```
text_bot/
│
├── config/
│   ├── init.py           # Пустой файл для пакета
│   ├── bot.py            # Конфигурация бота (токен, ID группы)
│   ├── triggers.py       # Триггеры и ответы
│
├── handlers/
│   ├── init.py           # Пустой файл
│   ├── commands.py       # Обработчик команды /start
│   ├── messages.py       # Обработчик текстовых сообщений
│
├── utils/
│   ├── init.py           # Пустой файл
│   ├── logging.py        # Настройка логирования
│   ├── response.py       # Логика отправки ответов и обработки ошибок
│
├── main.py                # Точка входа для запуска бота
├── requirements.txt       # Зависимости проекта
├── .gitignore             # Исключения для Git
├── .env                   # Пример файла с переменными окружения
├── README.md              # Документация проекта
├── triggers.json          # настройки триггеров и ответов бота
```

## Требования

- Python 3.8 или выше
- Токен Telegram-бота (получите через [BotFather](https://t.me/BotFather))
- ID целевой Telegram-группы
- Установленные зависимости из `requirements.txt`

## Установка

1. **Клонируйте репозиторий**:

   ```bash
   git clone <URL_репозитория>
   cd text_bot

2. **Создайте виртуальное окружение (рекомендуется)**:
    
   ```bash
    python -m venv venv
    source venv/bin/activate  # Linux/Mac
    venv\Scripts\activate     # Windows

3. **Установите зависимости**:
    
    ```bash
   pip install -r requirements.txt

4. **Настройте переменные окружения**:
    
    ```bash
   cp .env.example .env

5. **Отредактируйте .env, указав токен и ID группы**:
    
    ```
    TELEGRAM_TOKEN=ваш_токен
    GROUP_CHAT_ID=-123456789
    ```
6. **Добавьте .env в .gitignore**:

   **Убедитесь, что .env не отслеживается Git**:
    
    ```bash
   echo ".env" >> .gitignore


## Запуск

1. **Активируйте виртуальное окружение (если создавали)**:
    
    ```bash
    source venv/bin/activate  # Linux/Mac
    venv\Scripts\activate     # Windows
   
2. **Запустите бота**:
    
    ```bash
   python main.py
   
**Бот начнёт обрабатывать сообщения в указанной группе.**

## Использование

- Отправьте команду `/start` в чате с ботом, чтобы получить ID чата и подтверждение работы.
- Бот реагирует только на сообщения в группе с ID, указанным в `GROUP_CHAT_ID`.
- Настройка триггеров и ответов выполняется в файле `config/triggers.py`.

## Расширение

- Добавление триггеров: Добавьте новые экземпляры класса `Trigger` в `config/triggers.py`.
- Настройка логирования: Измените уровень или формат логов в `utils/logging.py`.
- Деплой: Настройте переменные окружения на сервере (Heroku, AWS, etc.) вместо `.env`.

## Устранение неполадок


- Ошибка `"chat not found"`: Проверьте, добавлен ли бот в группу и имеет ли он права на отправку сообщений.
- Конфликт `getUpdates`: Убедитесь, что запущен только один экземпляр бота. Удалите вебхук, если он активен:

    ```bash
  curl https://api.telegram.org/bot<TELEGRAM_TOKEN>/deleteWebhook

- Переменные окружения не найдены: Проверьте наличие и корректность файла .env.

## Зависимости

- `pip install python-telegram-bot` — для работы с Telegram API
- `pip install python-dotenv` — для загрузки переменных из .env

## Конфигурация файла переменных окружения (`.env`)

```commandline
TELEGRAM_TOKEN=<Ваш токен>

GROUP_CHAT_ID = -1234567890

RESPONSES=<Ответ-выражение>|<...>
```

## Конфигурация триггеров (`triggers.json`)

Файл `triggers.json` используется для настройки триггеров и ответов бота. Он должен быть валидным JSON-файлом и содержать массив объектов, каждый из которых описывает один триггер. Файл должен быть сохранён в кодировке UTF-8 и находиться в корневой директории проекта.

### Формат `triggers.json`

Каждый объект триггера содержит следующие поля:

- **pattern** (обязательное, строка): Регулярное выражение для поиска триггера в тексте.
- **response** (обязательное, строка или массив строк): Ответ бота. Если указан массив строк, бот случайным образом выбирает один из них. Если используется `use_env_response: true`, это поле игнорируется, и ответы берутся из переменной `RESPONSES` в `.env`.
- **delay** (обязательное, целое число): Задержка в секундах перед (по умолчанию) отправкой ответа.
- **log** (обязательное, строка): Сообщение для логирования при срабатывании триггера.
- **root_match** (необязательное, булево, по умолчанию `false`): Если `true`, триггер ищет подстроку в тексте; если `false`, требуется точное совпадение слова.
- **use_env_response** (необязательное, булево, по умолчанию `false`): Если `true`, бот использует список ответов из переменной `RESPONSES` в файле `.env` вместо указанного `response`.

### Пример `triggers.json`

```json
[
    {
        "pattern": "<строка1/подстрока1>|<...>|<...>",
        "use_env_response": true,
        "delay": 3,
        "log": "корень ключевого слова",
        "root_match": true
    },
    {
        "pattern": "<строка2>",
        "response": "<ответ-выражение1>",
        "delay": 1,
        "log": "слово '<строка2>'",
        "root_match": false
    },
    {
        "pattern": "<подстрока2>",
        "response": "<ответ-выражение2>",
        "delay": 2,
        "log": "корень '<подстрока2>'",
        "root_match": true
    }
]
```
